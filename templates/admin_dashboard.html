<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            min-height: 100vh;
        }
        .dashboard-container {
            max-width: 1000px;
            margin: 40px auto;
            background: rgba(255,255,255,0.95);
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.18);
            padding: 32px 40px;
        }
        h2 { color: #1976d2; margin-bottom: 10px; }
        .welcome {
            background: linear-gradient(90deg, #43cea2, #185a9d);
            color: #fff; padding: 12px 28px;
            border-radius: 8px; margin-bottom: 22px;
            display: inline-block;
        }
        .user-count { margin-bottom: 18px; color: #1976d2; font-weight: 500; }
        .alert {
            background: #e0f7fa; color: #006064;
            border: 1px solid #4dd0e1; padding: 10px;
            margin-bottom: 12px; border-radius: 5px;
        }
        h3 { color: #0093e9; margin-top: 30px; }
        #searchInput {
            margin-bottom: 18px; padding: 8px 12px;
            width: 270px; border: 1px solid #4dd0e1;
            border-radius: 5px; outline: none;
            background: #f0fcff; color: #1976d2;
        }
        table {
            border-collapse: collapse; width: 100%;
            background: #fafdff; margin-bottom: 22px;
            border-radius: 10px; overflow: hidden;
            box-shadow: 0 2px 12px rgba(33,147,176,0.07);
        }
        th, td {
            border: 1px solid #b2ebf2;
            padding: 12px 16px; text-align: left;
        }
        th {
            background: linear-gradient(90deg, #43cea2, #185a9d);
            color: #fff;
        }
        tr:nth-child(even) { background: #e0f7fa; }
        tr:hover { background: #b2ebf2 !important; }
        .remove-btn {
            background: linear-gradient(90deg, #2193b0, #6dd5ed);
            color: #fff; border: none; padding: 7px 18px;
            border-radius: 5px; cursor: pointer;
        }
        .remove-btn:hover {
            background: linear-gradient(90deg, #185a9d, #43cea2);
        }
        .back-link {
            text-decoration: none; color: #1976d2;
            font-weight: bold; display: inline-block;
            margin-top: 12px;
        }
        .back-link:hover { text-decoration: underline; color: #0093e9; }
     

    /* üìå Review cards (added here) */
    .reviews-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 15px;
    }

    .review-card {
        background: #f9fcff;
        border-left: 6px solid #2193b0;
        padding: 15px 18px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(33,147,176,0.15);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .review-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(33,147,176,0.25);
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .review-user {
        font-weight: 600;
        color: #185a9d;
    }
    .review-rating {
        background: #43cea2;
        color: white;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.9em;
    }
    .review-comment {
        font-size: 1em;
        color: #333;
        margin-bottom: 6px;
    }
    .review-date {
        font-size: 0.8em;
        color: #777;
    }

</style>
</head>
<body>
    <div class="dashboard-container">
        <h2 style="color:black"><strong>My_Dashboard</strong></h2>
        <div class="welcome" style="color:black">Welcome, Martin <strong>{{ session.username }}</strong></div>
        <div class="user-count" style="color:black">Total Registered Users: <strong>{{ users|length }}</strong></div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- üë• Manage Users -->
        <h3 style="color:black">Registered Users</h3>
        <input type="text" id="searchInput" placeholder="Search by username...">
        <table>
            <tr><th>ID</th><th>Username</th><th>Email</th><th>Action</th></tr>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>
                    <form method="post" style="display:inline; color:black">
                        <input type="hidden" name="remove_user_id" value="{{ user.id }}" >
                        <button type="submit" class="remove-btn"
                            onclick="return confirm('Remove {{ user.username }}?');">Remove</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>

        <!-- üìä App Review Analytics -->
        <h3><strong>App Review Analytics üìä</strong></h3>
        {% if total_reviews > 0 %}
            <p><strong>Average Rating:</strong> {{ "%.1f"|format(avg_rating) }}/5 ({{ total_reviews }} reviews)</p>

            <!-- ‚≠ê Rating Breakdown -->
            <table>
                <tr><th>Star Rating</th><th>Count</th></tr>
                {% for row in rating_counts %}
                <tr>
                    <td>{{ row['rating'] }} ‚≠ê</td>
                    <td>{{ row['count'] }}</td>
                </tr>
                {% endfor %}
            </table>
        {% endif %}

            <!-- üìù Recent Reviews -->
            <!-- üìù Pending Reviews (Admin Approval Needed) -->
<h3><strong>Pending Reviews (Approval Required)</strong></h3>
{% if pending_reviews %}
    <div class="reviews-container">
        {% for r in pending_reviews %}
           <div class="review-card">
                <div class="review-header">
                    <span class="review-user">üë§ {{ r['username'] }}</span>
                    <span class="review-rating">{{ r['rating'] }} ‚≠ê</span>
                </div>
                <div class="review-comment">
                      {{ r['comment'] or "No comment" }}
                </div>
                <div class="review-date">
                    üìÖ {{ r['created_at'] }}
                </div>

                <!-- ‚úÖ Approve / ‚ùå Delete actions -->
                <div style="margin-top:10px;">
                    <form method="post" style="display:inline;">
                        <input type="hidden" name="approve_review_id" value="{{ r['id'] }}">
                        <button type="submit" class="remove-btn" style="background:green;"
                            onclick="return confirm('Approve this review?');">‚úÖ Approve</button>
                    </form>
                    <form method="post" style="display:inline;">
                        <input type="hidden" name="delete_review_id" value="{{ r['id'] }}">
                        <button type="submit" class="remove-btn" style="background:red;"
                            onclick="return confirm('Delete this review?');">‚ùå Delete</button>
                    </form>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p>No pending reviews üéâ</p>
{% endif %}

        <a href="{{ url_for('predict_page') }}" class="back-link">üîô Back</a>
    </div>

    <!-- üîé User Search -->
    <script>
    document.getElementById('searchInput').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        document.querySelectorAll('table tr:not(:first-child)').forEach(function(row) {
            let username = row.cells[1].textContent.toLowerCase();
            row.style.display = username.includes(filter) ? '' : 'none';
        });
    });
    </script>
</body>
</html>
